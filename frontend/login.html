<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EUR COM SUITE — Login</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div class="ecs-shell">
        <header class="ecs-topbar">
            <div>
                <div class="ecs-brand">EUR COM SUITE</div>
                <div class="ecs-breadcrumbs">Sign in</div>
            </div>
        </header>

        <main class="ecs-center">
            <div class="ecs-auth">
                <h1>Sign in</h1>
                <p class="small">Demo users: employee1 / Employee123! — customer1 / Customer123!</p>

                <label for="username">Username</label>
                <input id="username" autocomplete="username" />

                <label for="password">Password</label>
                <input id="password" type="password" autocomplete="current-password" />

                <div style="margin-top:12px;">
                    <button id="btnLogin" class="btn btn-primary" style="width:100%;">Sign in</button>
                </div>

                <div id="status" class="small" style="margin-top:10px;"></div>
                <div id="error" class="error" style="margin-top:10px; white-space:pre-wrap;"></div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000/api";

        const elUser = document.getElementById("username");
        const elPass = document.getElementById("password");
        const elErr = document.getElementById("error");
        const elStatus = document.getElementById("status");
        const btn = document.getElementById("btnLogin");

        function clearSession() {
            localStorage.removeItem("ecs_token");
            localStorage.removeItem("ecs_user");
        }

        async function login() {
            elErr.textContent = "";
            elStatus.textContent = "Signing in...";

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: elUser.value.trim(),
                        password: elPass.value
                    })
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok) {
                    elStatus.textContent = "";
                    elErr.textContent = data?.detail ? JSON.stringify(data.detail) : JSON.stringify(data);
                    return;
                }

                // store token + user
                localStorage.setItem("ecs_token", data.access_token);
                localStorage.setItem("ecs_user", JSON.stringify(data.user));

                // verify immediately
                const meRes = await fetch(`${API_BASE}/me`, {
                    headers: { Authorization: `Bearer ${data.access_token}` }
                });

                if (!meRes.ok) {
                    clearSession();
                    elStatus.textContent = "";
                    elErr.textContent = "Login succeeded but /api/me failed. Please try again.";
                    return;
                }

                const me = await meRes.json();
                elStatus.textContent = `Logged in as ${me.username} (${me.role})`;

                // redirect by role
                if (me.role === "CUSTOMER") window.location.href = "customer.html";
                else window.location.href = "employee.html";

            } catch (e) {
                elStatus.textContent = "";
                elErr.textContent = String(e);
            }
        }

        btn.addEventListener("click", login);
        elPass.addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
    </script>
</body>

</html>