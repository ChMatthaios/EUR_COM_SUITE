<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Employee Portal — EUR COM SUITE</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div class="ecs-shell">
        <header class="ecs-topbar">
            <div>
                <div class="ecs-brand">EUR COM SUITE</div>
                <div class="ecs-breadcrumbs">Employee / Dashboard</div>
            </div>

            <div class="ecs-topbar-right">
                <button id="btnLogout" class="btn">Logout</button>
            </div>
        </header>

        <main class="ecs-main">
            <aside class="ecs-sidebar">
                <div class="ecs-nav-title">Employee</div>
                <nav class="ecs-nav">
                    <a href="employee.html" class="active">Dashboard</a>
                    <a href="viewer.html">Reports Viewer</a>
                </nav>
            </aside>

            <section class="ecs-content">
                <h1>Employee Portal</h1>
                <p class="small">If this page fails, it will show the exact reason below.</p>

                <div class="ecs-card">
                    <h3>Session</h3>
                    <div id="who" class="small"></div>
                    <div id="status" class="small" style="margin-top:8px;"></div>
                    <div id="error" class="error" style="margin-top:10px; white-space:pre-wrap;"></div>
                </div>

                <div class="ecs-section">
                    <div class="ecs-card">
                        <h3>Tools</h3>
                        <button id="btnGoViewer" class="btn btn-primary">Open Reports Viewer</button>
                        <p class="small" style="margin-top:10px;">
                            Viewer loads customers via <code>/api/customers</code> (paginated), no tier logic.
                        </p>
                    </div>
                </div>

                <div class="ecs-section">
                    <div class="ecs-card">
                        <h3>Debug</h3>
                        <pre id="debug" class="code"
                            style="white-space:pre-wrap; word-break:break-word; margin:0;"></pre>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000/api";

        const elWho = document.getElementById("who");
        const elStatus = document.getElementById("status");
        const elError = document.getElementById("error");
        const elDebug = document.getElementById("debug");

        function getToken() { return localStorage.getItem("ecs_token"); }

        function logout() {
            localStorage.removeItem("ecs_token");
            localStorage.removeItem("ecs_user");
            window.location.href = "login.html";
        }

        async function safeReadJson(res) {
            try { return await res.json(); } catch { return null; }
        }

        async function loadMe() {
            elError.textContent = "";
            elStatus.textContent = "Checking session...";

            const t = getToken();
            if (!t) {
                elStatus.textContent = "";
                elError.textContent = "No token found in localStorage (ecs_token). Redirecting to login...";
                setTimeout(logout, 800);
                return;
            }

            let res;
            try {
                res = await fetch(`${API_BASE}/me`, {
                    headers: { Authorization: `Bearer ${t}` },
                    cache: "no-store"
                });
            } catch (e) {
                // Αυτό είναι το πιο χρήσιμο για “Failed to fetch”
                elStatus.textContent = "";
                elError.textContent =
                    "Failed to fetch /api/me.\n" +
                    "- Is backend running on 127.0.0.1:8000?\n" +
                    "- Are you opening this page via Live Server (http://127.0.0.1:5500/...) and not file:// ?\n\n" +
                    "Error: " + String(e);
                return;
            }

            const data = await safeReadJson(res);

            if (!res.ok) {
                const detail = data?.detail ? (typeof data.detail === "string" ? data.detail : JSON.stringify(data.detail)) : JSON.stringify(data);
                elStatus.textContent = "";
                elError.textContent = `API ${res.status} ${res.statusText} on /api/me:\n${detail}`;

                if (res.status === 401) {
                    setTimeout(logout, 800);
                }
                return;
            }

            // store user
            localStorage.setItem("ecs_user", JSON.stringify(data));

            // guard role
            if (data.role === "CUSTOMER") {
                window.location.href = "customer.html";
                return;
            }

            elWho.textContent = `Signed in as ${data.username} (${data.role})`;
            elStatus.textContent = "Session OK.";
            elDebug.textContent = JSON.stringify(data, null, 2);
        }

        document.getElementById("btnLogout").addEventListener("click", logout);
        document.getElementById("btnGoViewer").addEventListener("click", () => {
            window.location.href = "viewer.html";
        });

        loadMe();
    </script>
</body>

</html>