<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Customer Portal — EUR COM SUITE</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div class="ecs-shell">
        <header class="ecs-topbar">
            <div>
                <div class="ecs-brand">EUR COM SUITE</div>
                <div class="ecs-breadcrumbs">Customer / Overview</div>
            </div>

            <div class="ecs-topbar-right">
                <button id="btnLogout" class="btn">Logout</button>
            </div>
        </header>

        <main class="ecs-main">
            <aside class="ecs-sidebar">
                <div class="ecs-nav-title">Customer</div>
                <nav class="ecs-nav">
                    <a href="customer.html" class="active">Overview</a>
                    <a href="viewer.html">My Reports</a>
                </nav>
            </aside>

            <section class="ecs-content">
                <h1>Customer Portal</h1>
                <p class="small">Simple, light, Confluence-style view.</p>

                <div class="ecs-card">
                    <h3>Session</h3>
                    <div id="who" class="small"></div>
                    <div id="status" class="small" style="margin-top:8px;"></div>
                </div>

                <div class="ecs-section">
                    <div class="ecs-card">
                        <h3>Reports</h3>
                        <p>Open your latest reports in the Viewer.</p>
                        <button id="btnGoViewer" class="btn btn-primary">Open Reports Viewer</button>
                    </div>
                </div>

                <div class="ecs-section">
                    <div class="ecs-card">
                        <h3>Debug</h3>
                        <pre id="debug" class="code"
                            style="white-space:pre-wrap; word-break:break-word; margin:0;"></pre>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000/api";

        function logout() {
            localStorage.removeItem("ecs_token");
            localStorage.removeItem("ecs_user");
            window.location.href = "login.html";
        }

        async function load() {
            const token = localStorage.getItem("ecs_token");
            if (!token) return logout();

            const meRes = await fetch(`${API_BASE}/me`, {
                headers: { Authorization: `Bearer ${token}` }
            });

            if (!meRes.ok) return logout();

            const me = await meRes.json();

            // Guard: customers only
            if (me.role !== "CUSTOMER") {
                window.location.href = "employee.html";
                return;
            }

            document.getElementById("who").textContent =
                `Signed in as ${me.username} (${me.role}) — customer_id=${me.customer_id}`;
            document.getElementById("status").textContent = "Session OK.";
            document.getElementById("debug").textContent = JSON.stringify(me, null, 2);
        }

        document.getElementById("btnLogout").addEventListener("click", logout);
        document.getElementById("btnGoViewer").addEventListener("click", () => {
            window.location.href = "viewer.html";
        });

        load().catch(err => {
            document.getElementById("status").textContent = "Error: " + String(err);
        });
    </script>
</body>

</html>